package randoop.condition.specification;

import com.google.gson.annotations.SerializedName;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;

/**
 * A specification of a constructor or method, aka, an <i>operation</i>. Consists of the {@code
 * java.lang.reflect.AccessibleObject} for the operation, and lists of {@link Precondition}, {@link
 * Postcondition}, and {@link ThrowsCondition} objects that describe contracts on the operation.
 *
 * <p>Method {@link randoop.condition.SpecificationCollection#create(java.util.List)} reads
 * specifications from JSON files. A user specifies JSON files using the {@code --specifications}
 * command-line option. The JSON should include a JSON object labeled by the name of each field of
 * this class, as in
 *
 * <pre>
 * {
 *   "operation": {
 *     "classname": "net.Connection",
 *     "name": "send",
 *     "parameterTypes": [
 *       "int"
 *     ]
 *   },
 *   "identifiers": {
 *     "parameters": [
 *       "signalValue"
 *     ],
 *     "receiverName": "receiver",
 *     "returnName": "result"
 *   },
 *   "pre": [
 *     {
 *       "description": "the signalValue must be positive",
 *       "guard": {
 *         "conditionText": {@code "signalValue > 0"},
 *         "description": "the signalValue must be positive"
 *       }
 *     }
 *   ],
 *   "post": [],
 *   "throws": [],
 * }
 * </pre>
 *
 * Method {@link
 * randoop.condition.SpecificationCollection#getExecutableSpecification(java.lang.reflect.Executable)}
 * translates specifications to an {@link randoop.condition.ExecutableSpecification} object that
 * allows the underlying Boolean expressions to be evaluated.
 */
@org.checkerframework.framework.qual.AnnotatedFor("org.checkerframework.checker.resourceleak.ResourceLeakChecker")
public class OperationSpecification {

    // NOTE: changing field names or @SerializedName annotations could affect integration with other
    // tools
    /**
     * The reflection object for the operation.
     */
    private final @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) OperationSignature operation;

    /**
     * The identifier names used in the specifications.
     */
    private final @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) Identifiers identifiers;

    /**
     * The list of pre-conditions for the operation.
     */
    private final @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) List<Precondition> preSpecifications;

    /**
     * The list of post-conditions for the operation.
     */
    private final @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) List<Postcondition> postSpecifications;

    /**
     * The specification of expected exceptions for the operation.
     */
    private final @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) List<ThrowsCondition> throwsSpecifications;

    /**
     * Gson serialization requires a default constructor.
     */
    @org.checkerframework.framework.qual.EnsuresQualifier(expression = { "this.operation" }, qualifier = org.checkerframework.checker.calledmethods.qual.CalledMethodsBottom.class)
    private OperationSpecification() {
        this.operation = null;
        this.identifiers = new Identifiers();
        this.preSpecifications = new ArrayList<>();
        this.postSpecifications = new ArrayList<>();
        this.throwsSpecifications = new ArrayList<>();
    }

    /**
     * Creates an {@link OperationSpecification} for the given operation with no specifications.
     *
     * @param operation the {@link OperationSignature} object, must be non-null
     * @param identifiers the {@link Identifiers} object, must be non-null
     */
    public OperationSpecification(OperationSignature operation, Identifiers identifiers) {
        this(operation, identifiers, // These cannot be Collections.emptyList() because the fields are mutable
        new ArrayList<Precondition>(), new ArrayList<Postcondition>(), new ArrayList<ThrowsCondition>());
    }

    /**
     * Creates an {@link OperationSpecification} for the given operation with the given
     * specifications.
     *
     * @param operation the reflection object for the operation, must be non-null
     * @param identifiers the identifiers used in the specifications
     * @param preSpecifications the list of param specifications for the operation
     * @param postSpecifications the list of return specifications for the operation
     * @param throwsSpecifications the list of specifications for the operation
     */
    public OperationSpecification(@org.checkerframework.checker.calledmethods.qual.CalledMethods({}) OperationSignature operation, @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) Identifiers identifiers, @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) List<Precondition> preSpecifications, @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) List<Postcondition> postSpecifications, @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) List<ThrowsCondition> throwsSpecifications) {
        this.operation = operation;
        this.identifiers = identifiers;
        this.preSpecifications = preSpecifications;
        this.postSpecifications = postSpecifications;
        this.throwsSpecifications = throwsSpecifications;
    }

    /**
     * Return the {@link OperationSignature} for the operation.
     *
     * @return the reflection object for the operation
     */
    @org.checkerframework.dataflow.qual.Pure
    public @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) OperationSignature getOperation(@org.checkerframework.checker.calledmethods.qual.CalledMethods({}) OperationSpecification this) {
        return operation;
    }

    /**
     * Return the {@link Identifiers} for this specification.
     *
     * @return the identifiers for this specification
     */
    @org.checkerframework.dataflow.qual.Pure
    public @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) Identifiers getIdentifiers(@org.checkerframework.checker.calledmethods.qual.CalledMethods({}) OperationSpecification this) {
        return identifiers;
    }

    /**
     * Return the list of {@link Precondition} objects for this {@link OperationSpecification}.
     *
     * @return the list of {@link Precondition} objects for this specification
     */
    @org.checkerframework.dataflow.qual.Pure
    public @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) List<Precondition> getPreconditions(@org.checkerframework.checker.calledmethods.qual.CalledMethods({ "getIdentifiers" }) OperationSpecification this) {
        return preSpecifications;
    }

    /**
     * Return the list of {@link Postcondition} objects for this {@link OperationSpecification}.
     *
     * @return the list of {@link Postcondition} objects for this specification
     */
    @org.checkerframework.dataflow.qual.Pure
    public @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) List<Postcondition> getPostconditions(@org.checkerframework.checker.calledmethods.qual.CalledMethods({ "getIdentifiers", "getPreconditions" }) OperationSpecification this) {
        return postSpecifications;
    }

    /**
     * Return the list of {@link ThrowsCondition} objects for this {@link OperationSpecification}.
     *
     * @return the list of specifications for this operation specification, is non-null
     */
    @org.checkerframework.dataflow.qual.Pure
    public @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) List<ThrowsCondition> getThrowsConditions(@org.checkerframework.checker.calledmethods.qual.CalledMethods({ "getIdentifiers", "getPostconditions", "getPreconditions" }) OperationSpecification this) {
        return throwsSpecifications;
    }

    /**
     * Adds {@link Precondition} objects from the list to this {@link OperationSpecification}.
     *
     * @param specifications the list of {@link Precondition} objects
     */
    @org.checkerframework.checker.calledmethods.qual.EnsuresCalledMethods(value = { "this.preSpecifications" }, methods = { "addAll" })
    public void addParamSpecifications(List<Precondition> specifications) {
        preSpecifications.addAll(specifications);
    }

    /**
     * Adds {@link Postcondition} objects from the list to this {@link OperationSpecification}.
     *
     * @param specifications the list of {@link Postcondition} objects
     */
    @org.checkerframework.checker.calledmethods.qual.EnsuresCalledMethods(value = { "this.postSpecifications" }, methods = { "addAll" })
    public void addReturnSpecifications(List<Postcondition> specifications) {
        postSpecifications.addAll(specifications);
    }

    /**
     * Adds {@link ThrowsCondition} objects from the list to this {@link OperationSpecification}.
     *
     * @param specifications the list of {@link ThrowsCondition} objects
     */
    @org.checkerframework.checker.calledmethods.qual.EnsuresCalledMethods(value = { "this.throwsSpecifications" }, methods = { "addAll" })
    public void addThrowsConditions(List<ThrowsCondition> specifications) {
        throwsSpecifications.addAll(specifications);
    }

    /**
     * Indicates whether this {@link OperationSpecification} contains any pre-, post-, or
     * throws-specifications.
     *
     * @return {@code true} if there are no pre-, post-, or throws-specifications, false otherwise
     */
    @org.checkerframework.checker.calledmethods.qual.EnsuresCalledMethods(value = { "this.preSpecifications" }, methods = { "isEmpty" })
    @org.checkerframework.dataflow.qual.Pure
    public  @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) boolean isEmpty() {
        return preSpecifications.isEmpty() && postSpecifications.isEmpty() && throwsSpecifications.isEmpty();
    }

    @org.checkerframework.dataflow.qual.Pure
    public  @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) boolean equals(@org.checkerframework.checker.calledmethods.qual.CalledMethods({}) OperationSpecification this, @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) Object object) {
        if (this == object) {
            return true;
        }
        if (!(object instanceof OperationSpecification)) {
            return false;
        }
        OperationSpecification other = (OperationSpecification) object;
        return this.operation.equals(other.operation) && this.identifiers.equals(other.identifiers) && this.preSpecifications.equals(other.preSpecifications) && this.postSpecifications.equals(other.postSpecifications) && this.throwsSpecifications.equals(other.throwsSpecifications);
    }

    @org.checkerframework.dataflow.qual.Pure
    public  @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) int hashCode(@org.checkerframework.checker.calledmethods.qual.CalledMethods({}) OperationSpecification this) {
        return Objects.hash(this.operation, this.identifiers, this.preSpecifications, this.postSpecifications, this.throwsSpecifications);
    }

    @org.checkerframework.checker.calledmethods.qual.EnsuresCalledMethods(value = { "this.operation" }, methods = { "toString" })
    @org.checkerframework.dataflow.qual.SideEffectFree
    public @org.checkerframework.checker.calledmethods.qual.CalledMethods({}) String toString(@org.checkerframework.checker.calledmethods.qual.CalledMethods({}) OperationSpecification this) {
        // Use a temporary variable to avoid interleaved output, when callees produce output.
        String result = "{ \"operation\": " + this.operation.toString() + ", \"identifiers\": " + this.identifiers + ", \"preSpecifications\": " + this.preSpecifications + " }, \"postSpecifications\": " + this.postSpecifications + ", \"throwsSpecifications\": " + this.throwsSpecifications;
        return result;
    }
}
